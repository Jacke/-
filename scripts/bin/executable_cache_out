#!/bin/bash
##################
# Command output memoize
# ./cache_out <Command> <op>
# Where <op>
# - drop   - Reinit a saved output
# - <none> - Fetch the latest output
##################
# TODO: Add params
PATH=$PATH:/usr/local/bin/
cmd=$1
operation=$2
SED_PATTERN="s/\/tmp\/${cmd}_cache.//g"

if compgen -G "/tmp/${cmd}_cache*" >/dev/null; then
  KEY="$(ls /tmp/${cmd}_cache* | sed ${SED_PATTERN})"
fi

# *DEBUG PANEL*
# echo "###################################"
# echo "KEY: ${KEY}"
# echo "cmd: ${cmd}"
# echo "operation: ${operation}"
# echo $FILE
# echo "###################################"

# hash last modified dates of any files
#for arg in "$@"
#do
#  if [ -f $arg ]
#  then
#    KEY+=`date -r "$arg" +\ %s`
#  fi
#done

if [ "$operation" == "drop" ]; then
  # echo "rm -rf /tmp/${cmd}*"
  rm -rf /tmp/$cmd*
  FILE="/tmp/${cmd}_cache.$(echo -n "$KEY" | md5sum | cut -c -10)"
else
  FILE="/tmp/${cmd}_cache.$KEY"
fi

# use cached file or execute the command and cache it
if [ -f $FILE ]; then
  cat $FILE
else
  $@ | tee $FILE
fi
